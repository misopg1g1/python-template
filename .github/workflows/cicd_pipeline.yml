name: CICD

on:
  push:
    branches:
      - production
      - staging

env:
  REGISTRY_USERNAME: ${{secrets.REGISTRY_USERNAME}}
  REGISTRY_PASSWORD: ${{secrets.REGISTRY_PASSWORD}}
  IMAGE_VERSION: $(date +%s)

jobs:
  #  test:
  #    runs-on: ubuntu-latest
  #    steps:
  #      - name: Checkout code
  #        uses: actions/checkout@v2
  #
  #      - name: Set up Python 3.10
  #        uses: actions/setup-python@v2
  #        with:
  #          python-version: "3.10"
  #
  #      - name: Update pip
  #        run: |
  #          python -m pip install --upgrade pip
  #      - name: Verificar archivo requirements.txt
  #        run: |
  #          if [ ! -f requirements.txt ]; then
  #            echo "requirements.txt no encontrado. No se ejecutar치 la acci칩n."
  #            exit 0
  #          fi
  #      - name: Install dependencies
  #        run: |
  #          python -m pip install -r requirements.txt
  #
  #      - name: Run tests
  #        run: |
  #          pytest
  build:
    #    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Verificar archivo Dockerfile
        run: |
          if [ ! -f Dockerfile ]; then
            echo "Dockerfile no encontrado. No se ejecutar치 la acci칩n."
            exit 0
          fi
      - name: Log in to registry
        run: |
          docker login --username $REGISTRY_USERNAME --password $REGISTRY_PASSWORD misoregistry.edgarluna.dev

      - name: Build and tag Docker image

        run: |
          repo_name=$(basename $GITHUB_REPOSITORY)
          branch_name=$(basename $GITHUB_REF)
          docker build . --file Dockerfile --tag misoregistry.edgarluna.dev/images/${repo_name}_${branch_name}:$IMAGE_VERSION --tag misoregistry.edgarluna.dev/images/${repo_name}_${branch_name}:latest

      - name: Push Docker image to registry
        run: |
          repo_name=$(basename $GITHUB_REPOSITORY)
          branch_name=$(basename $GITHUB_REF)
          docker push misoregistry.edgarluna.dev/images/${repo_name}_${branch_name}:$IMAGE_VERSION --tag misoregistry.edgarluna.dev/images/${repo_name}_${branch_name}:latest